version: '3.8'

services:
  aeron-mq-1:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aeron-mq-1
    hostname: aeron-mq-1
    environment:
      - NODE_ID=0
      - HOST=0.0.0.0
      - KAFKA_PORT=9092
      - DATA_DIR=/app/data
      - AERON_DIR=/dev/shm/aeron-mq-0
      - AUTO_CREATE_TOPICS=true
      - CLUSTER_MEMBERS=0,aeron-mq-1,20000|1,aeron-mq-2,20000|2,aeron-mq-3,20000
      - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dagrona.disable.bounds.checks=true
    ports:
      - "9092:9092"
    volumes:
      - aeron-mq-1-data:/app/data
      - aeron-mq-1-logs:/app/logs
    networks:
      - aeron-mq-network
    tmpfs:
      - /dev/shm:rw,nosuid,nodev,noexec,size=512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  aeron-mq-2:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aeron-mq-2
    hostname: aeron-mq-2
    environment:
      - NODE_ID=1
      - HOST=0.0.0.0
      - KAFKA_PORT=9092
      - DATA_DIR=/app/data
      - AERON_DIR=/dev/shm/aeron-mq-1
      - AUTO_CREATE_TOPICS=true
      - CLUSTER_MEMBERS=0,aeron-mq-1,20000|1,aeron-mq-2,20000|2,aeron-mq-3,20000
      - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dagrona.disable.bounds.checks=true
    ports:
      - "9093:9092"
    volumes:
      - aeron-mq-2-data:/app/data
      - aeron-mq-2-logs:/app/logs
    networks:
      - aeron-mq-network
    tmpfs:
      - /dev/shm:rw,nosuid,nodev,noexec,size=512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      aeron-mq-1:
        condition: service_healthy

  aeron-mq-3:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: aeron-mq-3
    hostname: aeron-mq-3
    environment:
      - NODE_ID=2
      - HOST=0.0.0.0
      - KAFKA_PORT=9092
      - DATA_DIR=/app/data
      - AERON_DIR=/dev/shm/aeron-mq-2
      - AUTO_CREATE_TOPICS=true
      - CLUSTER_MEMBERS=0,aeron-mq-1,20000|1,aeron-mq-2,20000|2,aeron-mq-3,20000
      - JAVA_OPTS=-Xms512m -Xmx2g -XX:+UseG1GC -XX:MaxGCPauseMillis=10 -Dagrona.disable.bounds.checks=true
    ports:
      - "9094:9092"
    volumes:
      - aeron-mq-3-data:/app/data
      - aeron-mq-3-logs:/app/logs
    networks:
      - aeron-mq-network
    tmpfs:
      - /dev/shm:rw,nosuid,nodev,noexec,size=512m
    ulimits:
      memlock:
        soft: -1
        hard: -1
      nofile:
        soft: 65536
        hard: 65536
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "9092"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    depends_on:
      aeron-mq-1:
        condition: service_healthy

networks:
  aeron-mq-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

volumes:
  aeron-mq-1-data:
  aeron-mq-1-logs:
  aeron-mq-2-data:
  aeron-mq-2-logs:
  aeron-mq-3-data:
  aeron-mq-3-logs:


